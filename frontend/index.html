<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B-Locate</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <img src="https://hackmd.io/_uploads/S1hmbK8-Wx.png" alt="Blocate" class="logo" style="transform: scale(2); transform-origin: left center; display:block; margin-right: 5%;">
      <h2 style="color: lightseagreen !important;">Blocate</h2>
    </div>
    
    <nav class="sidebar-nav">
      <a href="#dashboard" class="nav-item active" data-section="dashboard">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
        <span>Dashboard</span>
      </a>
      
      <a href="#patients" class="nav-item" data-section="patients">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <span>Patients</span>
      </a>
      
      <a href="#devices" class="nav-item" data-section="devices">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
          <line x1="12" y1="18" x2="12.01" y2="18"></line>
        </svg>
        <span>Devices</span>
      </a>
      
      <a href="#events" class="nav-item" data-section="events">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
        </svg>
        <span>Events</span>
      </a>
      
      <a href="#settings" class="nav-item" data-section="settings">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v6m0 6v6m8.66-15.66l-4.24 4.24m-8.48 8.48l-4.24 4.24M23 12h-6m-6 0H1m19.66 8.66l-4.24-4.24m-8.48-8.48l-4.24-4.24"></path>
        </svg>
        <span>Settings</span>
      </a>
    </nav>
    
    <div class="sidebar-footer">
      <div class="wallet-info">
        <div id="walletStatus" class="wallet-disconnected">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
          <span class="wallet-text">Not Connected</span>
        </div>
        <button id="connectBtn" class="btn-connect">Connect Wallet</button>
        <button id="disconnectBtn" class="btn-disconnect" style="display: none;">Disconnect</button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard Section -->
    <section id="dashboard" class="content-section active">
      <header class="page-header">
        <div>
          <h1>Patient Monitoring Dashboard</h1>
          <p class="page-subtitle">Real-time health metrics and location tracking</p>
        </div>
        <div class="header-actions">
          <div class="patient-selector" id="patientSelectorContainer" style="display: none; margin-right: 15px;">
            <label for="patientSelector" style="font-size: 14px; color: #94a3b8; margin-right: 8px;">Monitoring:</label>
            <select id="patientSelector" style="background: #1e293b; color: white; border: 1px solid #334155; padding: 8px 12px; border-radius: 8px; font-size: 14px; cursor: pointer;">
              <option value="">Select a patient...</option>
            </select>
          </div>
          <div class="network-badge" id="networkBadge">
            <span class="network-dot"></span>
            <span id="networkName">Not Connected</span>
          </div>
        </div>
      </header>

      <!-- Live Vitals Cards -->
      <div class="vitals-grid">
        <div class="vital-card">
          <div class="vital-header">
            <img src="https://hackmd.io/_uploads/H1oQZFIZ-x.png" alt="Heart Rate" class="vital-icon">
            <span class="vital-label">Heart Rate</span>
          </div>
          <div class="vital-value" id="bpmValue">--</div>
          <div class="vital-unit">BPM</div>
          <div class="vital-status normal" id="bpmStatus">Normal</div>
        </div>

        <div class="vital-card">
          <div class="vital-header">
            <img src="https://hackmd.io/_uploads/H1ombYL-bg.png" alt="Temperature" class="vital-icon">
            <span class="vital-label">Temperature</span>
          </div>
          <div class="vital-value" id="tempValue">--</div>
          <div class="vital-unit">Â°C</div>
          <div class="vital-status normal" id="tempStatus">Normal</div>
        </div>

        <div class="vital-card">
          <div class="vital-header">
            <img src="https://hackmd.io/_uploads/rykuWF8Zbx.png" alt="SpO2" class="vital-icon">
            <span class="vital-label">Blood Oxygen</span>
          </div>
          <div class="vital-value" id="spo2Value">--</div>
          <div class="vital-unit">%</div>
          <div class="vital-status normal" id="spo2Status">Normal</div>
        </div>

        <div class="vital-card">
          <div class="vital-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="vital-icon">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <span class="vital-label">Location Status</span>
          </div>
          <div class="vital-value small" id="locationStatus">Tracking...</div>
          <div class="vital-unit" id="distanceFromHome">--</div>
          <div class="vital-status normal" id="geoStatus">Within Boundary</div>
        </div>

        <div class="vital-card">
          <div class="vital-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="vital-icon">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            <span class="vital-label">Device Status</span>
          </div>
          <div class="vital-value small" id="deviceValue">--</div>
          <div class="vital-unit" id="lastUpdateTime">No data</div>
          <div class="vital-status" id="deviceStatus">
            <span class="status-dot"></span>
            <span id="deviceStatusText">Offline</span>
          </div>
        </div>
      </div>

      <!-- Alert Banner -->
      <div class="alert-banner" id="alertBanner" style="display: none;">
        <div class="alert-content">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
          <div class="alert-text" id="alertText">Alert message</div>
        </div>
        <button class="alert-close" onclick="document.getElementById('alertBanner').style.display='none'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Map and Charts Row -->
      <div class="dashboard-grid">
        <div class="map-container card">
          <div class="card-header">
            <h3>Patient Location</h3>
            <div class="last-update">
              Updated: <span id="lastUpdate">Never</span>
            </div>
          </div>
          <div id="map" class="map"></div>
          <div class="map-legend">
            <div class="legend-item">
              <span class="legend-marker home"></span>
              <span>Home Location</span>
            </div>
            <div class="legend-item">
              <span class="legend-marker current"></span>
              <span>Current Location</span>
            </div>
            <div class="legend-item">
              <span class="legend-circle"></span>
              <span>Safe Zone (500m)</span>
            </div>
          </div>
        </div>

        <div class="charts-container">
          <div class="card chart-card">
            <div class="card-header">
              <h3>Heart Rate Trend</h3>
            </div>
            <canvas id="bpmChart"></canvas>
          </div>

          <div class="card chart-card">
            <div class="card-header">
              <h3>Temperature Trend</h3>
            </div>
            <canvas id="tempChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Patients Section -->
    <section id="patients" class="content-section">
      <header class="page-header">
        <h1>My Patients</h1>
        <p class="page-subtitle">Patients you are monitoring as guardian</p>
      </header>

      <div class="patients-grid" id="patientsGrid">
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
          <p>No patients found</p>
          <small>Patients will appear here when they assign you as their guardian</small>
        </div>
      </div>
    </section>

    <!-- Devices Section -->
    <section id="devices" class="content-section">
      <header class="page-header">
        <div>
          <h1>Device Management</h1>
          <p class="page-subtitle">Register and manage patient monitoring devices</p>
        </div>
        <button class="btn-primary" onclick="document.getElementById('registerModal').style.display='flex'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Register New Device
        </button>
      </header>

      <div class="devices-grid" id="devicesGrid">
        <div class="empty-state">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
            <line x1="12" y1="18" x2="12.01" y2="18"></line>
          </svg>
          <p>No devices registered</p>
          <small>Click "Register New Device" to get started</small>
        </div>
      </div>

      <!-- Query Device Info -->
      <div class="card" style="margin-top: 2rem;">
        <div class="card-header">
          <h3>Query Device Information</h3>
        </div>
        <div class="card-body">
          <div class="form-row">
            <div class="form-group">
              <label>Device ID</label>
              <input type="text" id="queryDeviceId" placeholder="e.g., patient-001">
            </div>
            <div class="form-actions">
              <button id="getDeviceBtn" class="btn-primary">Get Device Info</button>
              <button id="getEventsBtn" class="btn-secondary">Get Events</button>
            </div>
          </div>
          <div id="deviceInfo" class="result-box"></div>
          <div id="eventsOutput" class="result-box"></div>
        </div>
      </div>
    </section>

    <!-- Events Section -->
    <section id="events" class="content-section">
      <header class="page-header">
        <h1>Event History</h1>
        <p class="page-subtitle">All recorded health events and alerts</p>
      </header>

      <div class="events-container">
        <div class="card">
          <div class="card-header">
            <h3>Recent Events</h3>
            <div class="filter-tabs">
              <button class="filter-tab active" data-filter="all">All</button>
              <button class="filter-tab" data-filter="normal">Normal</button>
              <button class="filter-tab" data-filter="alert">Alerts</button>
              <button class="filter-tab" data-filter="critical">Critical</button>
            </div>
          </div>
          <div class="events-list" id="eventsList">
            <div class="empty-state">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              <p>No events recorded</p>
              <small>Health events will appear here as they are logged</small>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="content-section">
      <header class="page-header">
        <h1>Settings</h1>
        <p class="page-subtitle">Manage your guardian profile and device settings</p>
      </header>

      <div class="settings-grid">
        <!-- Guardian Profile -->
        <div class="card">
          <div class="card-header">
            <h3>Guardian Profile</h3>
          </div>
          <div class="card-body">
            <p class="setting-description">Set your display name so patients can identify you easily.</p>
            
            <div id="currentGuardianNameDisplay" class="info-banner" style="display: none;">
              <strong>Current Display Name:</strong> <span id="currentGuardianNameText">--</span>
            </div>
            
            <div class="form-group">
              <label>Guardian Display Name</label>
              <input type="text" id="guardianNameInput" placeholder="e.g., Dr. Smith, Mom, John Doe" maxlength="50">
              <small>This name will be shown to all patients who assign you as their guardian.</small>
            </div>
            <button id="setGuardianNameBtn" class="btn-primary">Update Name</button>
            
            <div id="guardianNameStatus" class="result-box"></div>
          </div>
        </div>

        <!-- Change Guardian -->
        <div class="card">
          <div class="card-header">
            <h3>Transfer Guardian Role</h3>
          </div>
          <div class="card-body">
            <p class="setting-description">As a patient, change who monitors your device.</p>
            
            <div class="form-group">
              <label>Device ID</label>
              <input type="text" id="changeGuardianDeviceId" placeholder="e.g., patient-002">
            </div>
            <div class="form-group">
              <label>New Guardian Wallet Address</label>
              <input type="text" id="newGuardianAddress" placeholder="0x...">
              <small>Enter the wallet address of the new guardian</small>
            </div>
            <button id="changeGuardianBtn" class="btn-primary">Change Guardian</button>
            
            <div id="changeGuardianStatus" class="result-box"></div>
          </div>
        </div>

        <!-- Contract Info -->
        <div class="card">
          <div class="card-header">
            <h3>Contract Information</h3>
          </div>
          <div class="card-body">
            <div class="info-row">
              <span class="info-label">Network:</span>
              <span class="info-value" id="networkNameSettings">Not Connected</span>
            </div>
            <div class="info-row">
              <span class="info-label">Contract Address:</span>
              <code class="info-value contract-addr" id="contractAddress">Loading...</code>
            </div>
            <div class="info-row">
              <span class="info-label">Connected Wallet:</span>
              <code class="info-value" id="connectedWallet">Not Connected</code>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Register Device Modal -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Register New Device</h2>
        <button class="modal-close" onclick="document.getElementById('registerModal').style.display='none'">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <form id="registerForm" class="modal-body">
        <div class="form-group">
          <label>Device ID</label>
          <input type="text" id="deviceId" placeholder="e.g., patient-001" required>
          <small>Unique identifier for the IoT device</small>
        </div>
        <div class="form-group">
          <label>Patient Name</label>
          <input type="text" id="patientName" placeholder="e.g., John Doe" required>
        </div>
        <div class="form-group">
          <label>Age</label>
          <input type="number" id="age" placeholder="e.g., 65" min="1" max="150" required>
        </div>
        <div class="form-group">
          <label>Guardian Wallet Address</label>
          <input type="text" id="guardianAddress" placeholder="0x... (leave empty to use your wallet)">
          <small>Leave empty to be your own guardian, or enter another wallet address</small>
        </div>
        <div class="form-group">
          <label>Home Location (GPS)</label>
          <input type="text" id="homeGPS" placeholder="e.g., 14.5995,120.9842" required>
          <small>Format: latitude,longitude (used for geofencing alerts)</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-secondary" onclick="document.getElementById('registerModal').style.display='none'">Cancel</button>
          <button type="submit" class="btn-primary">Register Device</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module" src="/main.js"></script>
</body>
</html>
