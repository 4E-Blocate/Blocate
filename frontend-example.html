<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Monitor - Frontend Example</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        .status-card h3 {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .status-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .events {
            margin-top: 30px;
        }
        .event-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
        .event-card.alert {
            border-left-color: #ffc107;
        }
        .event-card.critical {
            border-left-color: #dc3545;
        }
        .event-card h4 {
            margin-bottom: 5px;
            color: #333;
        }
        .event-card p {
            color: #666;
            font-size: 14px;
        }
        .config {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .config h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .config input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        .config label {
            display: block;
            margin-bottom: 5px;
            color: #856404;
            font-weight: bold;
        }
        .config-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè• DePIN Patient Monitor</h1>
        <p class="subtitle">Decentralized IoT Health Monitoring System</p>

        <div class="config">
            <h3>‚öôÔ∏è Configuration</h3>
            <div class="config-group">
                <label>Contract Address:</label>
                <input type="text" id="contractAddress" placeholder="0x...">
            </div>
            <div class="config-group">
                <label>RPC URL:</label>
                <input type="text" id="rpcUrl" value="http://127.0.0.1:8545">
            </div>
            <div class="config-group">
                <label>Device ID:</label>
                <input type="text" id="deviceId" value="ESP32-SIMULATOR-001">
            </div>
        </div>

        <div>
            <button onclick="connectWallet()">üîó Connect Wallet</button>
            <button onclick="loadStats()" id="loadBtn" disabled>üìä Load Stats</button>
            <button onclick="loadEvents()" id="eventsBtn" disabled>üìã Load Events</button>
        </div>

        <div class="status">
            <div class="status-card">
                <h3>Wallet</h3>
                <div class="value" id="walletAddress">Not Connected</div>
            </div>
            <div class="status-card">
                <h3>Total Devices</h3>
                <div class="value" id="totalDevices">-</div>
            </div>
            <div class="status-card">
                <h3>Total Events</h3>
                <div class="value" id="totalEvents">-</div>
            </div>
            <div class="status-card">
                <h3>Network</h3>
                <div class="value" id="network">-</div>
            </div>
        </div>

        <div class="events">
            <h2>üì° Recent Events</h2>
            <div id="eventsList">
                <p style="color: #666; text-align: center; padding: 40px;">Connect wallet and load events to see data</p>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ABI = [
            "function registerDevice(string deviceId, address guardian) external",
            "function logEvent(string deviceId, bytes32 dataHash, string eventType) external",
            "function getDevice(string deviceId) external view returns (tuple(string deviceId, address patient, address guardian, bool isActive, uint256 registeredAt))",
            "function getDeviceEvents(string deviceId, uint256 limit) external view returns (tuple(string deviceId, bytes32 dataHash, address guardian, string eventType, uint256 timestamp)[])",
            "function getTotalDevices() external view returns (uint256)",
            "function getTotalEvents() external view returns (uint256)"
        ];

        let provider, signer, contract;

        async function connectWallet() {
            try {
                const contractAddr = document.getElementById('contractAddress').value;
                const rpcUrl = document.getElementById('rpcUrl').value;

                if (!contractAddr) {
                    alert('Please enter contract address');
                    return;
                }

                // Connect to custom RPC (Ganache)
                provider = new ethers.JsonRpcProvider(rpcUrl);
                
                // For local testing with Ganache, use a predefined account
                const privateKey = '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80';
                signer = new ethers.Wallet(privateKey, provider);

                // Get network info
                const network = await provider.getNetwork();
                document.getElementById('network').textContent = `Chain ${network.chainId}`;

                // Connect to contract
                contract = new ethers.Contract(contractAddr, CONTRACT_ABI, signer);

                // Display wallet address
                document.getElementById('walletAddress').textContent = 
                    signer.address.substring(0, 6) + '...' + signer.address.substring(38);

                // Enable buttons
                document.getElementById('loadBtn').disabled = false;
                document.getElementById('eventsBtn').disabled = false;

                console.log('‚úÖ Connected to contract:', contractAddr);
                alert('Wallet connected! Click "Load Stats" to see data.');
                
            } catch (error) {
                console.error('Connection failed:', error);
                alert('Failed to connect: ' + error.message);
            }
        }

        async function loadStats() {
            try {
                const totalDevices = await contract.getTotalDevices();
                const totalEvents = await contract.getTotalEvents();

                document.getElementById('totalDevices').textContent = totalDevices.toString();
                document.getElementById('totalEvents').textContent = totalEvents.toString();

                console.log('‚úÖ Stats loaded');
            } catch (error) {
                console.error('Failed to load stats:', error);
                alert('Failed to load stats: ' + error.message);
            }
        }

        async function loadEvents() {
            try {
                const deviceId = document.getElementById('deviceId').value;
                const events = await contract.getDeviceEvents(deviceId, 20);

                const eventsList = document.getElementById('eventsList');
                
                if (events.length === 0) {
                    eventsList.innerHTML = '<p style="color: #666; text-align: center; padding: 40px;">No events found for this device</p>';
                    return;
                }

                eventsList.innerHTML = events.map(event => {
                    const date = new Date(Number(event.timestamp) * 1000);
                    const eventClass = event.eventType === 'critical' ? 'critical' : 
                                      event.eventType === 'alert' ? 'alert' : '';
                    
                    return `
                        <div class="event-card ${eventClass}">
                            <h4>${event.eventType.toUpperCase()} - ${event.deviceId}</h4>
                            <p>üìÖ ${date.toLocaleString()}</p>
                            <p>üîê Hash: ${event.dataHash.substring(0, 20)}...</p>
                            <p>üõ°Ô∏è Guardian: ${event.guardian.substring(0, 10)}...</p>
                        </div>
                    `;
                }).join('');

                console.log(`‚úÖ Loaded ${events.length} events`);
            } catch (error) {
                console.error('Failed to load events:', error);
                alert('Failed to load events: ' + error.message);
            }
        }

        // Auto-load contract address from localStorage
        window.onload = () => {
            const savedAddress = localStorage.getItem('contractAddress');
            if (savedAddress) {
                document.getElementById('contractAddress').value = savedAddress;
            }
        };

        // Save contract address on change
        document.getElementById('contractAddress').addEventListener('change', (e) => {
            localStorage.setItem('contractAddress', e.target.value);
        });
    </script>
</body>
</html>
